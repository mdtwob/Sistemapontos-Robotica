{% extends "ponto_app/base.html" %}
{% load static %}

{% block title %}Gerenciar Usuários | LabRobo Point{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">
            {% if is_admin %}
                Gerenciamento Completo de Usuários
            {% else %}
                Gerenciamento de Alunos e Usuários
            {% endif %}
        </h2>
    </div>

    <p class="text-muted">
        Clique em <strong>Editar</strong> para mudar as informações. Apenas Administradores podem excluir ou editar perfis de Professor/Estagiário.
    </p>

    <div class="card shadow-sm p-4">

        {% if is_admin %}
        <div class="mb-3" style="max-width: 320px;">
            <label class="form-label fw-semibold">Filtrar por Nível de Acesso:</label>
            <select id="filtro-nivel" class="form-select" onchange="applyFilter(this.value)">
                {% for nivel_value, nivel_display in niveis_acesso %}
                <option value="{{ nivel_value }}" {% if current_filter == nivel_value %}selected{% endif %}>
                    {{ nivel_display }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div id="user-list-container" class="mt-4">
            <ul class="list-group">

                {% for perfil in usuarios %}
                <li class="list-group-item d-flex justify-content-between align-items-center py-3" id="user-{{ perfil.user.id }}">

                    <div>
                        <h5 class="mb-1">{{ perfil.user.get_full_name|default:perfil.user.username }}</h5>
                        <small class="text-muted">
                            Função:
                            <span class="fw-bold 
                                {% if perfil.nivel_acesso == 'ADMIN' %} text-danger 
                                {% elif perfil.nivel_acesso == 'PROFESSOR' %} text-success 
                                {% else %} text-primary {% endif %}">
                                {{ perfil.get_nivel_acesso_display }}
                            </span>
                            | CPF: {{ perfil.cpf }}
                        </small>
                    </div>

                    <div class="d-flex gap-2">
                        <a href="{% url 'editar_perfil_usuario' user_id=perfil.user.id %}" class="btn btn-sm btn-primary">
                            Editar
                        </a>

                        {% if is_admin and perfil.nivel_acesso != 'ADMIN' %}
                        <button class="btn btn-sm btn-danger" onclick="confirmExclusao({{ perfil.user.id }}, '{{ perfil.user.get_full_name|default:perfil.user.username }}')">
                            Excluir
                        </button>
                        {% endif %}
                    </div>

                </li>
                {% empty %}
                <li class="list-group-item text-center text-secondary py-3">
                    Nenhum usuário encontrado com as suas permissões e filtros atuais.
                </li>
                {% endfor %}

            </ul>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // Função para aplicar o filtro
    function applyFilter(nivel) {
        window.location.href = `{% url 'gerenciar_usuarios' %}?nivel=${nivel}`;
    }

    // Função para exclusão com AJAX
    function confirmExclusao(userId, userName) {
        if (confirm(`Tem certeza que deseja EXCLUIR o usuário ${userName}? Esta ação é irreversível!`)) {
            // O token CSRF deve estar disponível no DOM (adicionado no base.html)
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value; 
            
            // CONSTRÓI A URL CORRETA
            const url = `{% url 'excluir_usuario' user_id=0 %}`.replace('0', userId);
            
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    const userElement = document.getElementById(`user-${userId}`);
                    if (userElement) {
                        userElement.remove();
                    }
                } else {
                    alert(`Falha ao excluir: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Erro de exclusão:', error);
                alert('Erro de conexão ao tentar excluir o usuário.');
            });
        }
    }
</script>
{% endblock %}