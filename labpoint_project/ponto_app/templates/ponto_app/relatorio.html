{% extends "ponto_app/base.html" %}
{% load static %}

{% block title %}Gerar Relatório | LabRobo Point{% endblock %}

{% block extra_head %}
<style>
.relatorio-table-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 4px;
}
.report-status-message {
    padding: 15px;
    text-align: center;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="text-center mb-4 fw-bold">Relatório de Ponto</h2>

    <div class="row g-4">

        <!-- CARD DE FILTROS -->
        <div class="col-lg-4 col-md-5">
            <div class="card shadow-sm p-3">
                <h5 class="mb-3">Filtros</h5>

                <form id="relatorio-form" onsubmit="event.preventDefault(); carregarRelatorio();">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Tipo de Período</label>
                        <select class="form-select" id="filtro-tipo" onchange="toggleCpfField()">
                            <option value="dia">Dia</option>
                            <option value="semana">Semana</option>
                            <option value="mes">Mês</option>
                            <option value="anual">Ano</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Data Inicial</label>
                        <input type="date" id="data-inicio" class="form-control" required value="{{ 'now'|date:'Y-m-d' }}">
                    </div>

                    <div class="mb-3" id="cpf-group">
                        <label class="form-label fw-semibold">CPF (opcional)</label>
                        <input type="text" id="cpf-filter" class="form-control" maxlength="11" placeholder="00000000000">
                    </div>

                    <button class="btn btn-danger w-100 py-2">Visualizar</button>
                </form>

                <button onclick="generatePdfSimulation()" class="btn btn-dark w-100 mt-2 py-2">
                    Gerar PDF
                </button>
            </div>
        </div>

        <!-- CARD RESULTADOS -->
        <div class="col-lg-8 col-md-7">
            <div class="card shadow-sm p-3">
                <h5 class="mb-2">Resultado</h5>
                <span id="periodo-display" class="text-muted"></span>
                <div id="relatorio-output" class="mt-3">
                    <div class="alert alert-danger text-center">
                        Configure os filtros e clique em <strong>Visualizar</strong>.
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // Função principal que chama a API do Django
    function carregarRelatorio() {
        const outputDiv = document.getElementById('relatorio-output');
        const cpf = document.getElementById('cpf-filter').value.trim();
        const tipo = document.getElementById('filtro-tipo').value;
        const dataInicio = document.getElementById('data-inicio').value;

        if (!dataInicio) {
            outputDiv.innerHTML = '<div class="alert alert-danger">Selecione uma data para o filtro.</div>';
            return;
        }

        outputDiv.innerHTML = '<div class="report-status-message" style="color: var(--primary-color);">Carregando dados...</div>';

        const data = {
            cpf: cpf,
            tipo: tipo,
            data_inicio: dataInicio,
        };

        fetch("{% url 'buscar_relatorio_pontos' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderizarTabela(data.dados, data.periodo);
            } else {
                outputDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        })
        .catch(error => {
            outputDiv.innerHTML = '<div class="alert alert-danger">Erro de rede. Verifique a conexão com o servidor.</div>';
            console.error('Erro ao buscar relatório:', error);
        });
    }

    // Função que constrói a tabela HTML
    function renderizarTabela(pontos, periodo) {
        const outputDiv = document.getElementById('relatorio-output');
        const periodoDisplay = document.getElementById('periodo-display');
        
        if (pontos.length === 0) {
            outputDiv.innerHTML = '<div class="report-status-message">Nenhum registro de ponto encontrado para o período/usuário selecionado.</div>';
            periodoDisplay.textContent = '';
            return;
        }

        periodoDisplay.textContent = `(${periodo.inicio} a ${periodo.fim})`;

        let tableHTML = `
            <div class="relatorio-table-container">
            <table>
                <thead>
                    <tr>
                        <th style="padding: 10px 15px;">Data</th>
                        <th style="padding: 10px 15px;">Hora</th>
                        <th style="padding: 10px 15px;">Nome</th>
                        <th style="padding: 10px 15px;">CPF</th>
                        <th style="padding: 10px 15px;">Tipo</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        pontos.forEach(ponto => {
            const tipoColor = ponto.tipo === 'ENTRADA' ? 'var(--success-color)' : 'var(--danger-color)';
            tableHTML += `
                <tr>
                    <td style="padding: 10px 15px;">${ponto.data}</td>
                    <td style="padding: 10px 15px;">${ponto.hora}</td>
                    <td style="padding: 10px 15px;">${ponto.nome} (${ponto.nivel})</td>
                    <td style="padding: 10px 15px;">${ponto.cpf}</td>
                    <td style="style=padding: 10px 15px; color: ${tipoColor}; font-weight: 600;">${ponto.tipo}</td>
                </tr>
            `;
        });
        
        tableHTML += `
                </tbody>
            </table>
            </div>
        `;
        
        outputDiv.innerHTML = tableHTML;
    }

    function generatePdfSimulation() {
    const outputDiv = document.getElementById('relatorio-output');
    const cpf = document.getElementById('cpf-filter').value.trim();
    const tipo = document.getElementById('filtro-tipo').value;
    const dataInicio = document.getElementById('data-inicio').value;

    if (!dataInicio) {
        outputDiv.innerHTML = '<div class="alert alert-danger">Selecione uma data para o filtro.</div>';
        return;
    }

    const data = {
        cpf: cpf,
        tipo: tipo,
        data_inicio: dataInicio,
    };

    // Abre a URL de PDF em uma nova aba
    const url = "{% url 'gerar_relatorio_pdf' %}";
    
    // Para chamar uma rota POST em uma nova aba, é necessário usar um formulário temporário
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    form.target = '_blank'; // Abre em nova aba

    // Adiciona o token CSRF
    const csrfField = document.createElement('input');
    csrfField.type = 'hidden';
    csrfField.name = 'csrfmiddlewaretoken';
    csrfField.value = getCsrfToken();
    form.appendChild(csrfField);

    // Adiciona os dados do JSON como um campo oculto (o Django irá ler o corpo da requisição)
    const jsonField = document.createElement('input');
    jsonField.type = 'hidden';
    jsonField.name = 'json_data'; // Usaremos 'json_data' para enviar os filtros
    jsonField.value = JSON.stringify(data);
    form.appendChild(jsonField);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}
</script>
{% endblock %}

