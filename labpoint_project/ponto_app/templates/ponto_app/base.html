<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LabRobo Point{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    {% load static %}
    <!-- <link rel="stylesheet" href="{% static 'css/styles.css' %}"> -->
    {% block extra_head %}{% endblock %}
</head>

{% csrf_token %} 
<div class="shadow-lg card container-fluid row-gap-2">
    <div class="row align-items-center justify-content-between">
        <div class="col-md-auto">
            <a href="{% url 'tela_ponto' %}">
                <img src="{% static 'img/logo_robo.png' %}" class="rounded float-start" alt="LabRobo Point Logo"
                    width="160" height="140">
            </a>
        </div>

        {% if user.is_authenticated %}
        <div class="col-md-auto">
            <a class="btn btn-secondary btn-lg text-nowrap" href="{% url 'perfil' %}">
                {% if user.perfil.foto_perfil %}
                <img src="{{ user.perfil.foto_perfil.url }}" alt="Foto de Perfil" width="90" height="90"
                    class="img-fluid rounded-circle align-text-center text-nowrap">
                {% else %}
                <img src="{% static 'img/default.png' %}" alt="Foto de Perfil" width="90" height="80"
        class="img-fluid rounded-circle align-text-center text-nowrap">
                {% endif %}
                {{ user.get_full_name|default:user.username }}({{ user.perfil.nivel_acesso }})
            </a>
        </div>

        <form class="col-md-auto" method="post" action="{% url 'logout' %}">
            {% csrf_token %}
        
            
            <button type="submit" class="btn btn-danger btn-lg"><i class="bi bi-box-arrow-in-left text-nowrap"></i>Sair</button>

        </form>

        {% else %}
        <div class="col-md-auto">
            <a href="{% url 'login' %}" class="btn btn-danger btn-lg text-nowrap"><i class="bi bi-shield-lock"></i>Acesso Administrativo</a>
        </div>
            
        {% endif %}            
             
        <div class="col-md-auto">
                <button class="btn btn-lg text-nowrap" id="theme-toggle" title="Alternar Tema"><i
                        class="bi bi-moon-fill" id="icon-light"></i>
                    <i class="bi bi-brightness-high" id="icon-dark"></i>
                    <span id="theme-text"></span>
                    </button>
            </div>
    </div>
    <div class="row  align-items-center justify-content-evenly mb-4">
        {% if user.is_authenticated %}
        {% if user.perfil.nivel_acesso in "ADMIN|PROFESSOR|ESTAGIARIO" %}
        <div class="col-md-auto">
            <a class="btn btn-danger btn-lg text-nowrap" href="{% url 'cadastro' %}"><i class="bi bi-person-plus"></i>Cadastrar Novo Aluno</a>
        </div>
        <div class="col-md-auto">
            <a class="btn btn-danger btn-lg text-nowrap" href="{% url 'relatorio' %}"><i class="bi bi-file-earmark-plus"></i>Gerar Relatório</a>
        </div>
        {% endif %}
        {% endif %}
        {% if user.perfil.nivel_acesso == "ADMIN" %}
        <div class="col-md-auto">
            <a class="btn btn-danger btn-lg text-nowrap" href="{% url 'gerenciar_usuarios' %}"><i class="bi bi-person-gear"></i>Gerenciar Usuários</a>
        </div>
        {% elif user.perfil.nivel_acesso in "PROFESSOR|ESTAGIARIO" %}
        <div class="col-md-auto">
            <a class="btn btn-danger btn-lg text-nowrap" href="{% url 'gerenciar_usuarios' %}"><i class="bi bi-person-vcard"></i>Gerenciar Alunos</a>
        </div>
    </br>
        {% endif %}
    </div>
</div>
<!-- <a href="{% url 'tela_ponto' %}">Ponto</a> -->

<div>
    {% block content %}
    {% endblock %}
</div>

{% block extra_js %}
<script>
    // Função para obter o token CSRF
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function handleBaterPonto(event) {
        event.preventDefault();
        const cpf = document.getElementById('cpf-input').value.trim();
        const messageBox = document.getElementById('ponto-message');

        // Limpa a mensagem anterior
        messageBox.style.display = 'none';
        messageBox.classList.remove('action-success', 'alert-danger');

        if (cpf.length !== 11 || isNaN(cpf)) {
            messageBox.textContent = 'Por favor, insira um CPF válido (11 dígitos).';
            messageBox.classList.add('alert-danger');
            messageBox.style.display = 'block';
            return;
        }

        fetch("{% url 'bater_ponto' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // AQUI ESTÁ A CHAVE: Enviando o Token CSRF
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ cpf: cpf })
        })
            .then(response => {
                // Verifica o status HTTP para saber se é erro 404/400 ou sucesso
                if (!response.ok) {
                    // Lança um erro para ser capturado no .catch
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Erro de servidor.');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Sucesso: Ponto registrado
                messageBox.textContent = data.message;
                messageBox.classList.add('action-success');
                messageBox.style.display = 'block';
                document.getElementById('cpf-input').value = '';
            })
            .catch(error => {
                // Falha: Erro do servidor (404, 400, ou falha de conexão)
                let errorMessage = error.message || 'Erro de conexão do servidor. Verifique o console para mais detalhes.';

                // Tratamento específico para o erro de token (embora não deva acontecer com a correção)
                if (errorMessage.includes('CSRF')) {
                    errorMessage = 'Erro de segurança (CSRF). Recarregue a página e tente novamente.';
                }

                messageBox.textContent = errorMessage;
                messageBox.classList.add('alert-danger');
                messageBox.style.display = 'block';
                console.error('Erro ao bater ponto:', error);
            });
    }
</script>
{% endblock %}
'"'
<script>
const toggleButton = document.getElementById('theme-toggle');
const htmlElement = document.documentElement;
const themeText = document.getElementById('theme-text');
const iconDark = document.getElementById('icon-dark');
const iconLight = document.getElementById('icon-light');

// Função central para atualizar o UI (ícone e texto)
function updateUI(theme) {
    if (theme === 'dark') {
        toggleButton.classList.remove('btn-dark');
        toggleButton.classList.add('btn-light');
        themeText.textContent = 'Tema Claro';
        iconDark.style.display = 'block'; // Mostra a lua
        iconLight.style.display = 'none'; // Esconde o sol
    } else {
        toggleButton.classList.remove('btn-light');
        toggleButton.classList.add('btn-dark');
        themeText.textContent = 'Tema Escuro';
        iconDark.style.display = 'none'; // Esconde a lua
        iconLight.style.display = 'block'; // Mostra o sol
    }
}

// 1. Função para aplicar o tema salvo
function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    htmlElement.setAttribute('data-bs-theme', savedTheme);
    
    // Atualiza o texto e o ícone na inicialização
    updateUI(savedTheme);
    
    // (Opcional: Mantenha aqui o gerenciamento de classes CSS customizadas, se necessário)
}

// 2. Alternar o tema ao clicar no botão
toggleButton.addEventListener('click', () => {
    const currentTheme = htmlElement.getAttribute('data-bs-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    htmlElement.setAttribute('data-bs-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Atualiza o texto e o ícone na alternância
    updateUI(newTheme);

    // (Opcional: Mantenha aqui o gerenciamento de classes CSS customizadas, se necessário)
});

// 3. Aplica o tema ao carregar a página
applySavedTheme();
</script>
</body>

</html>