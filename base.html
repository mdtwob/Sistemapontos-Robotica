<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LabRobo Point{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    {% load static %}
    <!-- <link rel="stylesheet" href="{% static 'css/styles.css' %}"> -->
    {% block extra_head %}{% endblock %}
</head>
<!-- <body onload="loadTheme()"> -->

{% csrf_token %}
<div class="container-fluid">
    <div class="row align-items-center justify-content-between">
        <div class="col-md-auto">
            <a href="{% url 'tela_ponto' %}">
                <img src="{% static 'img/logo_robo.png' %}" class="rounded float-start" alt="LabRobo Point Logo"
                    width="160" height="140">
            </a>
        </div>

        {% if user.is_authenticated %}
        <div class="col-md-auto">
            <a href="{% url 'perfil' %}">
                <img src="{{ user.perfil.foto_perfil.url }}" alt="Foto de Perfil" width="100" height="80"
                    class="d-inline-block align-text-top text-nowrap">
                {{ user.get_full_name|default:user.username }}({{ user.perfil.nivel_acesso }})
            </a>
        </div>

        <form class="col-md-auto" method="post" action="{% url 'logout' %}">
            {% csrf_token %}
        
            
            <button type="submit" class="btn btn-danger btn-lg"><i class="bi bi-box-arrow-in-left text-nowrap"></i>Sair</button>

        </form>

        {% else %}
        <div class="col-md-auto">
            <a href="{% url 'login' %}" class="btn btn-warning btn-lg text-nowrap"><i class="bi bi-shield-lock"></i>Acesso Administrativo</a>
        </div>
            
        {% endif %}            
             
        <div class="col-md-auto">
                <a href="{% url 'login' %}" class="btn btn-secondary btn-lg text-nowrap"><i
                        class="bi bi-person-circle"></i>Cadastro</a>
            </div>
        <div class="col-md-auto">
                <button onclick="toggleTheme()" class="btn btn-secondary btn-lg text-nowrap" title="Alternar Tema"><i
                        class="bi bi-moon-fill"></i>Tema Escuro</button>
            </div>

    </div>
</div>
<!-- <a href="{% url 'tela_ponto' %}">Ponto</a> -->

{% if user.is_authenticated %}
{% if user.perfil.nivel_acesso in "ADMIN|PROFESSOR|ESTAGIARIO" %}
<a href="{% url 'cadastro' %}">Cadastrar Novo Aluno</a>
<a href="{% url 'relatorio' %}">Gerar Relatório</a>
{% endif %}

{% if user.perfil.nivel_acesso == "ADMIN" %}
<a href="{% url 'gerenciar_usuarios' %}">Gerenciar Usuários</a>
{% elif user.perfil.nivel_acesso in "PROFESSOR|ESTAGIARIO" %}
<a href="{% url 'gerenciar_usuarios' %}">Gerenciar Alunos</a>
{% endif %}
{% endif %}

<div>
    {% block content %}
    {% endblock %}
</div>

{% block extra_js %}
<script>
    // Função para obter o token CSRF
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function handleBaterPonto(event) {
        event.preventDefault();
        const cpf = document.getElementById('cpf-input').value.trim();
        const messageBox = document.getElementById('ponto-message');

        // Limpa a mensagem anterior
        messageBox.style.display = 'none';
        messageBox.classList.remove('action-success', 'alert-danger');

        if (cpf.length !== 11 || isNaN(cpf)) {
            messageBox.textContent = 'Por favor, insira um CPF válido (11 dígitos).';
            messageBox.classList.add('alert-danger');
            messageBox.style.display = 'block';
            return;
        }

        fetch("{% url 'bater_ponto' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // AQUI ESTÁ A CHAVE: Enviando o Token CSRF
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ cpf: cpf })
        })
            .then(response => {
                // Verifica o status HTTP para saber se é erro 404/400 ou sucesso
                if (!response.ok) {
                    // Lança um erro para ser capturado no .catch
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Erro de servidor.');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Sucesso: Ponto registrado
                messageBox.textContent = data.message;
                messageBox.classList.add('action-success');
                messageBox.style.display = 'block';
                document.getElementById('cpf-input').value = '';
            })
            .catch(error => {
                // Falha: Erro do servidor (404, 400, ou falha de conexão)
                let errorMessage = error.message || 'Erro de conexão do servidor. Verifique o console para mais detalhes.';

                // Tratamento específico para o erro de token (embora não deva acontecer com a correção)
                if (errorMessage.includes('CSRF')) {
                    errorMessage = 'Erro de segurança (CSRF). Recarregue a página e tente novamente.';
                }

                messageBox.textContent = errorMessage;
                messageBox.classList.add('alert-danger');
                messageBox.style.display = 'block';
                console.error('Erro ao bater ponto:', error);
            });
    }
</script>
{% endblock %}

<script>
    function toggleTheme() {
        const body = document.body;
        body.classList.toggle('light-mode');

        if (body.classList.contains('light-mode')) {
            localStorage.setItem('theme', 'light');
        } else {
            localStorage.setItem('theme', 'dark');
        }

        updateThemeIcon();
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        const body = document.body;

        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else {
            body.classList.remove('light-mode');
        }
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const icon = document.getElementById('theme-toggle-icon');
        if (icon) {
            if (document.body.classList.contains('light-mode')) {
                icon.innerHTML = '&#9788;';
                icon.title = 'Mudar para Modo Escuro';
            } else {
                icon.innerHTML = '&#9790;';
                icon.title = 'Mudar para Modo Claro';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', loadTheme);
</script>
</body>

</html>